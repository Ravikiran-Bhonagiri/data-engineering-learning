# Day 07: Macros, Incremental, CI/CD

**Goal:** Learn advanced dbt features.

---

## Create a Macro

**File:** `macros/cents_to_dollars.sql`
```sql
{% macro cents_to_dollars(column_name) %}
    ({{ column_name }} / 100.0)::decimal(10,2)
{% endmacro %}
```

**Use in model:**
```sql
SELECT
    order_id,
    {{ cents_to_dollars('amount_cents') }} AS amount_dollars
FROM {{ ref('orders') }}
```

---

## Incremental Model

**File:** `models/marts/fct_orders_incremental.sql`
```sql
{{
    config(
        materialized='incremental',
        unique_key='order_id'
    )
}}

SELECT
    order_id,
    customer_id,
    order_date,
    amount
FROM {{ source('raw', 'orders') }}

{% if is_incremental() %}
    WHERE order_date > (SELECT MAX(order_date) FROM {{ this }})
{% endif %}
```

**How it works:**
- First run: Loads all data
- Subsequent runs: Only new rows (faster!)

**Run:**
```bash
dbt run --select fct_orders_incremental
dbt run --select fct_orders_incremental --full-refresh  # Rebuild from scratch
```

---

## CI/CD with GitHub Actions

**File:** `.github/workflows/dbt_ci.yml`
```yaml
name: dbt CI
on: [pull_request]

jobs:
  dbt_run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install dbt-postgres
      - run: dbt deps
      - run: dbt build  # Run models + tests
```

This runs on every pull request and fails the PR if tests fail!

---

**âœ… Day 7 Complete:** You know advanced dbt features.  
**ðŸŽ“ Course Complete!** Use `03_QUICK_Reference.md` for daily lookups â†’
