# Day 02: Models, ref(), and Dependencies

**Goal:** Master dependency management with `ref()`.

---

## The `ref()` Function

**Bad (hard-coded):**
```sql
SELECT * FROM analytics.stg_customers  -- What if this changes?
```

**Good (dbt managed):**
```sql
SELECT * FROM {{ ref('stg_customers') }}  -- dbt tracks this!
```

---

## Create Staging Models

**File:** `models/staging/stg_customers.sql`
```sql
WITH source AS (
    SELECT * FROM {{ source('raw', 'customers') }}
),

cleaning AS (
    SELECT
        id AS customer_id,
        first_name,
        last_name,
        LOWER(email) AS email,
        city,
        state,
        created_at
    FROM source
    WHERE email IS NOT NULL
)

SELECT * FROM cleaning
```

**File:** `models/staging/stg_orders.sql`
```sql
SELECT
    id AS order_id,
    customer_id,
    order_date,
    status,
    amount
FROM {{ source('raw', 'orders') }}
WHERE status != 'cancelled'
```

---

## Create Mart Model (Uses ref())

**File:** `models/marts/dim_customers.sql`
```sql
WITH customers AS (
    SELECT * FROM {{ ref('stg_customers') }}
),

orders AS (
    SELECT
        customer_id,
        COUNT(*) AS total_orders,
        SUM(amount) AS lifetime_value
    FROM {{ ref('stg_orders') }}
    GROUP BY 1
),

final AS (
    SELECT
        c.customer_id,
        c.first_name || ' ' || c.last_name AS full_name,
        c.email,
        c.city,
        c.state,
        COALESCE(o.total_orders, 0) AS total_orders,
        COALESCE(o.lifetime_value, 0) AS lifetime_value,
        c.created_at
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
)

SELECT * FROM final
```

---

## Run and Check DAG

```bash
dbt run
dbt docs generate && dbt docs serve
```

In the docs, click the DAG icon. You'll see:
```
raw.customers ──► stg_customers ──┐
                                  ├──► dim_customers
raw.orders ────► stg_orders ──────┘
```

dbt figured out the build order automatically!

---

**✅ Day 2 Complete:** You understand dependencies and `ref()`.  
**Next:** `02_Day_03.md` (Sources & Seeds) →
