# ğŸ—“ï¸ Day 7: Recursive CTEs & Advanced Queries

## ğŸ“š Topics Covered
- Recursive CTE syntax
- Hierarchy traversal
- Tree depth calculation
- Date/number series generation

---

## ğŸ¯ Problem 1: Recursive Employee Hierarchy
**Difficulty: Hard** | **Concept: Recursive CTE**

Build a complete org chart showing all levels.

```sql
-- Write your solution here
```

<details>
<summary>ğŸ’¡ Click for Solution</summary>

```sql
WITH RECURSIVE org_chart AS (
    -- Base case: top-level employees (no manager)
    SELECT 
        id,
        name,
        manager_id,
        1 AS level,
        name AS path
    FROM employees
    WHERE manager_id IS NULL
    
    UNION ALL
    
    -- Recursive case
    SELECT 
        e.id,
        e.name,
        e.manager_id,
        oc.level + 1,
        oc.path || ' > ' || e.name
    FROM employees e
    JOIN org_chart oc ON e.manager_id = oc.id
)
SELECT 
    REPEAT('  ', level - 1) || name AS org_tree,
    level,
    path
FROM org_chart
ORDER BY path;
```
</details>

---

## ğŸ¯ Problem 2: Calculate Tree Depth
**Difficulty: Medium** | **Concept: Recursive counting**

Find the maximum depth of the employee hierarchy.

```sql
-- Write your solution here
```

<details>
<summary>ğŸ’¡ Click for Solution</summary>

```sql
WITH RECURSIVE hierarchy AS (
    SELECT id, manager_id, 1 AS depth
    FROM employees
    WHERE manager_id IS NULL
    
    UNION ALL
    
    SELECT e.id, e.manager_id, h.depth + 1
    FROM employees e
    JOIN hierarchy h ON e.manager_id = h.id
)
SELECT MAX(depth) AS max_depth FROM hierarchy;
```
</details>

---

## ğŸ¯ Problem 3: Generate Number Series
**Difficulty: Easy** | **Concept: Recursive generation**

Generate numbers 1 to 10 using recursive CTE.

```sql
-- Write your solution here
```

<details>
<summary>ğŸ’¡ Click for Solution</summary>

```sql
WITH RECURSIVE numbers AS (
    SELECT 1 AS n
    UNION ALL
    SELECT n + 1 FROM numbers WHERE n < 10
)
SELECT * FROM numbers;
```
</details>

---

## ğŸ¯ Problem 4: Generate Date Range
**Difficulty: Medium** | **Concept: Recursive dates**

Generate all dates in January 2024.

```sql
-- Write your solution here
```

<details>
<summary>ğŸ’¡ Click for Solution</summary>

```sql
WITH RECURSIVE date_range AS (
    SELECT DATE '2024-01-01' AS dt
    UNION ALL
    SELECT dt + INTERVAL '1 day'
    FROM date_range
    WHERE dt < DATE '2024-01-31'
)
SELECT dt FROM date_range;
```
</details>

---

## ğŸ¯ Problem 5: Find All Subordinates
**Difficulty: Hard** | **Concept: Recursive hierarchy**

Find all direct and indirect reports for a manager (id=1).

```sql
-- Write your solution here
```

<details>
<summary>ğŸ’¡ Click for Solution</summary>

```sql
WITH RECURSIVE subordinates AS (
    -- Direct reports of John Smith (id=1)
    SELECT id, name, manager_id
    FROM employees
    WHERE manager_id = 1
    
    UNION ALL
    
    -- Indirect reports
    SELECT e.id, e.name, e.manager_id
    FROM employees e
    JOIN subordinates s ON e.manager_id = s.id
)
SELECT * FROM subordinates;
```
</details>

---

## ğŸ¯ Problem 6: Path to Root
**Difficulty: Hard** | **Concept: Reverse hierarchy**

For each employee, show their management chain to CEO.

```sql
-- Write your solution here
```

<details>
<summary>ğŸ’¡ Click for Solution</summary>

```sql
WITH RECURSIVE mgmt_chain AS (
    SELECT id, name, manager_id, 
           name AS chain,
           1 AS depth
    FROM employees
    
    UNION ALL
    
    SELECT mc.id, mc.name, e.manager_id,
           e.name || ' > ' || mc.chain,
           mc.depth + 1
    FROM mgmt_chain mc
    JOIN employees e ON mc.manager_id = e.id
)
SELECT name, chain
FROM mgmt_chain
WHERE manager_id IS NULL OR depth = (
    SELECT MAX(depth) FROM mgmt_chain mc2 WHERE mc2.id = mgmt_chain.id
);
```
</details>

---

## ğŸ“ Day 7 Interview Questions

1. **What is a recursive CTE?**
   - Self-referencing CTE with base case and recursive case
   - Uses UNION ALL to combine results

2. **What are the two parts of a recursive CTE?**
   - Base case (anchor member) - starting point
   - Recursive case - references the CTE itself

3. **How do you prevent infinite loops?**
   - Add WHERE condition to stop recursion
   - Use MAXRECURSION option (SQL Server)

---

## âœ… Day 7 Checklist

- [ ] Completed all 6 problems
- [ ] Understand recursive CTE structure
- [ ] Can traverse hierarchies
- [ ] Know how to generate series
