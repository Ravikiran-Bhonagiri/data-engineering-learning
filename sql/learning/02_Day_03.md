# üóìÔ∏è Day 3: Aggregations & GROUP BY

## üìö Topics Covered
- Aggregate functions: COUNT, SUM, AVG, MIN, MAX
- GROUP BY clause
- HAVING clause (filtering groups)
- NULL handling in aggregations

---

## üéØ Problem 1: Employee Count by Department
**Difficulty: Easy** | **Concept: COUNT + GROUP BY**

Count employees in each department.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    d.name AS department,
    COUNT(e.id) AS employee_count
FROM departments d
LEFT JOIN employees e ON d.id = e.department_id
GROUP BY d.id, d.name
ORDER BY employee_count DESC;
```

**Expected Result:**
```
department  | employee_count
------------|---------------
Engineering | 4
Sales       | 4
Marketing   | 2
Finance     | 1
HR          | 1
```
</details>

---

## üéØ Problem 2: Average Salary by Department
**Difficulty: Easy** | **Concept: AVG + GROUP BY**

Calculate average salary per department, rounded to 2 decimals.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    d.name AS department,
    ROUND(AVG(e.salary), 2) AS avg_salary
FROM departments d
JOIN employees e ON d.id = e.department_id
GROUP BY d.id, d.name
ORDER BY avg_salary DESC;
```

**Expected Result:**
```
department  | avg_salary
------------|------------
Finance     | 140000.00
Engineering | 111250.00
Sales       | 94250.00
Marketing   | 92500.00
HR          | 95000.00
```
</details>

---

## üéØ Problem 3: High Payroll Departments
**Difficulty: Medium** | **Concept: HAVING**

Find departments where total salary > $200,000.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    d.name AS department,
    SUM(e.salary) AS total_payroll
FROM departments d
JOIN employees e ON d.id = e.department_id
GROUP BY d.id, d.name
HAVING SUM(e.salary) > 200000
ORDER BY total_payroll DESC;
```

**Expected Result:**
```
department  | total_payroll
------------|---------------
Engineering | 445000
Sales       | 377000
```
</details>

---

## üéØ Problem 4: Orders Per Month
**Difficulty: Medium** | **Concept: Date extraction + GROUP BY**

Count orders and total revenue per month in 2024.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    TO_CHAR(order_date, 'YYYY-MM') AS month,
    COUNT(*) AS order_count,
    SUM(amount) AS total_revenue
FROM orders
WHERE EXTRACT(YEAR FROM order_date) = 2024
GROUP BY TO_CHAR(order_date, 'YYYY-MM')
ORDER BY month;
```

**Expected Result:**
```
month   | order_count | total_revenue
--------|-------------|---------------
2024-01 | 3           | 4595.94
2024-02 | 3           | 2799.96
2024-03 | 4           | 5649.91
2024-04 | 1           | 1299.99
```
</details>

---

## üéØ Problem 5: Customer Order Statistics
**Difficulty: Medium** | **Concept: Multiple aggregates**

For each customer: order count, total spent, average order value.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    c.name AS customer,
    COUNT(o.id) AS order_count,
    COALESCE(SUM(o.amount), 0) AS total_spent,
    COALESCE(ROUND(AVG(o.amount), 2), 0) AS avg_order
FROM customers c
LEFT JOIN orders o ON c.id = o.customer_id
GROUP BY c.id, c.name
ORDER BY total_spent DESC;
```
</details>

---

## üéØ Problem 6: Find Duplicate Emails
**Difficulty: Easy** | **Concept: HAVING COUNT > 1**

Query to find duplicate emails (returns empty if none).

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT email, COUNT(*) AS count
FROM customers
WHERE email IS NOT NULL
GROUP BY email
HAVING COUNT(*) > 1;
```
</details>

---

## üéØ Problem 7: Product Category Revenue
**Difficulty: Medium** | **Concept: JOIN + GROUP BY**

Total revenue and units sold per product category.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    p.category,
    SUM(oi.quantity * oi.unit_price) AS total_revenue,
    SUM(oi.quantity) AS units_sold
FROM products p
JOIN order_items oi ON p.id = oi.product_id
GROUP BY p.category
ORDER BY total_revenue DESC;
```

**Expected Result:**
```
category    | total_revenue | units_sold
------------|---------------|------------
Electronics | 13589.78      | 17
Furniture   | 1845.95       | 4
```
</details>

---

## üéØ Problem 8: Order Status Breakdown
**Difficulty: Easy** | **Concept: COUNT + percentage**

Show count and percentage of orders by status.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    status,
    COUNT(*) AS count,
    ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER(), 2) AS percentage
FROM orders
GROUP BY status
ORDER BY count DESC;
```

**Expected Result:**
```
status    | count | percentage
----------|-------|------------
completed | 7     | 58.33
pending   | 4     | 33.33
shipped   | 1     | 8.33
```
</details>

---

## üéØ Problem 9: Top 5 Products by Quantity
**Difficulty: Medium** | **Concept: SUM + LIMIT**

Find top 5 products by quantity sold.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    p.name,
    SUM(oi.quantity) AS total_sold,
    SUM(oi.quantity * oi.unit_price) AS revenue
FROM products p
JOIN order_items oi ON p.id = oi.product_id
GROUP BY p.id, p.name
ORDER BY total_sold DESC
LIMIT 5;
```
</details>

---

## üéØ Problem 10: Salary Range by Department
**Difficulty: Medium** | **Concept: MIN, MAX, AVG**

Show min, max, avg salary for each department.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    d.name AS department,
    MIN(e.salary) AS min_salary,
    MAX(e.salary) AS max_salary,
    ROUND(AVG(e.salary), 2) AS avg_salary,
    MAX(e.salary) - MIN(e.salary) AS salary_range
FROM departments d
JOIN employees e ON d.id = e.department_id
GROUP BY d.id, d.name
ORDER BY salary_range DESC;
```
</details>

---

## üéØ Problem 11: Customers With High Orders
**Difficulty: Medium** | **Concept: HAVING with AVG**

Find customers with average order value > $1000.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    c.name,
    COUNT(o.id) AS order_count,
    ROUND(AVG(o.amount), 2) AS avg_order
FROM customers c
JOIN orders o ON c.id = o.customer_id
GROUP BY c.id, c.name
HAVING AVG(o.amount) > 1000;
```
</details>

---

## üéØ Problem 12: Daily Order Summary
**Difficulty: Easy** | **Concept: GROUP BY date**

Show orders per day with total and average amount.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    order_date,
    COUNT(*) AS orders,
    SUM(amount) AS total,
    ROUND(AVG(amount), 2) AS avg_amount
FROM orders
GROUP BY order_date
ORDER BY order_date;
```
</details>

---

## üéØ Problem 13: Products Never Ordered
**Difficulty: Medium** | **Concept: LEFT JOIN + NULL check**

Find products that have never been ordered.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT p.name, p.category, p.price
FROM products p
LEFT JOIN order_items oi ON p.id = oi.product_id
WHERE oi.id IS NULL;
```
</details>

---

## üéØ Problem 14: Count with Multiple Conditions
**Difficulty: Medium** | **Concept: Conditional COUNT**

Count completed vs pending orders per customer.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    c.name,
    COUNT(CASE WHEN o.status = 'completed' THEN 1 END) AS completed,
    COUNT(CASE WHEN o.status = 'pending' THEN 1 END) AS pending,
    COUNT(CASE WHEN o.status = 'shipped' THEN 1 END) AS shipped
FROM customers c
LEFT JOIN orders o ON c.id = o.customer_id
GROUP BY c.id, c.name
ORDER BY c.name;
```
</details>

---

## üéØ Problem 15: Most Recent Hire Per Department
**Difficulty: Medium** | **Concept: MAX date + GROUP BY**

Find the most recent hire date for each department.

```sql
-- Write your solution here
```

<details>
<summary>üí° Click for Solution</summary>

```sql
SELECT 
    d.name AS department,
    MAX(e.hire_date) AS latest_hire
FROM departments d
JOIN employees e ON d.id = e.department_id
GROUP BY d.id, d.name
ORDER BY latest_hire DESC;
```
</details>

---

## üìù Day 3 Interview Questions

1. **What's the difference between WHERE and HAVING?**
   - WHERE filters rows BEFORE grouping
   - HAVING filters groups AFTER aggregation
   - HAVING can use aggregate functions, WHERE cannot

2. **How does NULL affect COUNT(*) vs COUNT(column)?**
   - COUNT(*) counts all rows including NULLs
   - COUNT(column) counts only non-NULL values

3. **Can you use column aliases in HAVING?**
   - Usually no in standard SQL (HAVING runs before SELECT)
   - Some databases like MySQL allow it

4. **What's the execution order?**
   - FROM ‚Üí WHERE ‚Üí GROUP BY ‚Üí HAVING ‚Üí SELECT ‚Üí ORDER BY

5. **How to get percentage of total in each group?**
   - Use window function: `100.0 * COUNT(*) / SUM(COUNT(*)) OVER()`

---

## ‚úÖ Day 3 Checklist

- [ ] Completed all 15 problems
- [ ] Understand COUNT(*) vs COUNT(column)
- [ ] Know when to use HAVING vs WHERE
- [ ] Can calculate percentages with window functions
- [ ] Comfortable with multiple aggregates in one query
