# Day 7: Unity Catalog (UC)

**Time:** 2 hours  
**Goal:** Implement centralized governance for data and AI assets.

---

## üîê The Governance Problem

Before UC:
- Permissions tied to specific Workspaces.
- No central view of "Who has access to what?"
- Hard to share data between regions.

With UC:
- **One Metastore** per region (e.g., us-east-1).
- Permissions applied at account level (Identity Federation).
- Lineage tracking across all workspaces.

---

## üìã The Object Model

1. **Metastore:** Container for metadata.
2. **Catalog:** Top container (`prod`, `dev`).
3. **Schema (Database):** container for tables.
4. **Volume:** Container for unstructured files (PDFs, Images).
5. **Table:** The data.

Namespace: `catalog.schema.table`

---

## üõ† Hands-on: Setting Up UC

### 1. Create Catalog
```sql
CREATE CATALOG IF NOT EXISTS dev_catalog;
```

### 2. Create Schema
```sql
CREATE SCHEMA IF NOT EXISTS dev_catalog.finance;
```

### 3. Managed vs External Tables

**Managed Table:**
Databricks manages the file storage location (in the Metastore root bucket).
```sql
CREATE TABLE dev_catalog.finance.orders (id INT, amount DOUBLE);
```

**External Table:**
You define the storage location (`s3://my-bucket/orders`). Requires a **Storage Credential** and **External Location**.
```sql
CREATE TABLE dev_catalog.finance.legacy_orders 
LOCATION 's3://my-company-data/orders';
```

---

## üõ°Ô∏è Access Control (GRANTs)

SQL-standard privileges.

```sql
-- Grant creation rights
GRANT CREATE TABLE ON SCHEMA dev_catalog.finance TO `data_engineers`;

-- Grant read access
GRANT SELECT ON TABLE dev_catalog.finance.orders TO `analysts`;

-- Dynamic View (Column Masking)
CREATE VIEW v_orders AS
SELECT 
  id, 
  CASE WHEN is_account_group_member('admin') THEN ssn ELSE '***' END as ssn
FROM orders;
```

---

## üï∏ Lineage

Unity Catalog automatically tracks lineage for any query run on a UC Cluster.

- **Table Lineage:** "Table A created Table B".
- **Column Lineage:** "Column X in Table A influenced Column Y in Table B".

Viewable in the **Catalog Explorer** UI under the "Lineage" tab.

---

## üéØ Interview Q&A

**Q: What is the difference between Hive Metastore (legacy) and Unity Catalog?**
A: Hive Metastore is workspace-local. Permissions are often managed via cluster settings or file-system ACLs. Unity Catalog is account-global. It provides a single permission model (SQL `GRANT`) for files, tables, and ML models across all workspaces.

**Q: How do you access S3 data in Unity Catalog?**
A: You do NOT use access keys. You create a **Storage Credential** (IAM Role), then wrap it in an **External Location** (defining a bucket path). You then GRANT access to that External Location to users or create External Tables on top of it.

**Q: How does UC help with GDPR/CCPA?**
A: Column-level lineage lets you trace PII usage. Dynamic views allow masking PII without duplicating data. Deleting a user's data in the source propagates visibility to downstream lineage.

---

**Next:** [Day 8: MLflow & ML](./02_Day_08.md)
